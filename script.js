// Study Plan Data
const studyPlan = {
    "title": "Plano de Estudos - Auxiliar de EscritÃ³rio",
    "sections": [
        {
            "title": "Semanas 1-2 (05-17/08)",
            "objective": "Revisar o bÃ¡sico e identificar onde vocÃª erra mais",
            "days": [
                {
                    "day_of_week": "Seg",
                    "activities": [
                        "PortuguÃªs: InterpretaÃ§Ã£o de texto",
                        "MatemÃ¡tica: Quatro operaÃ§Ãµes",
                        "Anotar erros e dÃºvidas"
                    ]
                },
                {
                    "day_of_week": "Ter",
                    "activities": [
                        "Conhecimentos EspecÃ­ficos: funÃ§Ãµes do cargo",
                        "PortuguÃªs: Ortografia",
                        "QuestÃµes rÃ¡pidas (5 a 10)"
                    ]
                },
                {
                    "day_of_week": "Qua",
                    "activities": [
                        "MatemÃ¡tica: FraÃ§Ãµes e porcentagem",
                        "Conhecimentos EspecÃ­ficos: atendimento",
                        "Resumo do dia"
                    ]
                },
                {
                    "day_of_week": "Qui",
                    "activities": [
                        "PortuguÃªs: PontuaÃ§Ã£o e crase",
                        "MatemÃ¡tica: ProporÃ§Ã£o",
                        "Flashcards de revisÃ£o"
                    ]
                },
                {
                    "day_of_week": "Sex",
                    "activities": [
                        "Conhecimentos EspecÃ­ficos: organizaÃ§Ã£o, arquivos",
                        "PortuguÃªs: AcentuaÃ§Ã£o e tipos de palavras",
                        "Mini simulado (10 questÃµes)"
                    ]
                },
                {
                    "day_of_week": "SÃ¡b",
                    "activities": [
                        "Simulado parcial (20 questÃµes)",
                        "CorreÃ§Ã£o + anÃ¡lise de erros",
                        "ReforÃ§o nos erros"
                    ]
                },
                {
                    "day_of_week": "Seg (2Âª semana)",
                    "activities": [
                        "PortuguÃªs: Pronomes e verbos",
                        "MatemÃ¡tica: Regra de trÃªs",
                        "Caderno de erros"
                    ]
                },
                {
                    "day_of_week": "Ter (2Âª semana)",
                    "activities": [
                        "Conhecimentos EspecÃ­ficos: atendimento ao pÃºblico",
                        "PortuguÃªs: ConcordÃ¢ncia verbal e nominal",
                        "QuestÃµes prÃ¡ticas"
                    ]
                },
                {
                    "day_of_week": "Qua (2Âª semana)",
                    "activities": [
                        "MatemÃ¡tica: SituaÃ§Ãµes-problema",
                        "Conhecimentos EspecÃ­ficos: arquivos e protocolo",
                        "Anotar dÃºvidas e revisar"
                    ]
                },
                {
                    "day_of_week": "Qui (2Âª semana)",
                    "activities": [
                        "PortuguÃªs: Classes gramaticais",
                        "MatemÃ¡tica: RevisÃ£o geral",
                        "Revisar flashcards"
                    ]
                },
                {
                    "day_of_week": "Sex (2Âª semana)",
                    "activities": [
                        "Conhecimentos EspecÃ­ficos: textos administrativos",
                        "RedaÃ§Ã£o administrativa curta",
                        "Revisar portuguÃªs"
                    ]
                },
                {
                    "day_of_week": "SÃ¡b (2Âª semana)",
                    "activities": [
                        "Simulado 1 (40 questÃµes cronometrado)",
                        "CorreÃ§Ã£o e marcaÃ§Ã£o dos erros",
                        "Revisar sÃ³ os erros"
                    ]
                }
            ]
        },
        {
            "title": "Semanas 3-4 (18-31/08)",
            "objective": "Aprofundar e aumentar volume de questÃµes",
            "days": [
                {
                    "day_of_week": "Seg",
                    "activities": [
                        "PortuguÃªs: ConjunÃ§Ãµes e conectivos",
                        "MatemÃ¡tica: Porcentagem",
                        "Releitura de resumos"
                    ]
                },
                {
                    "day_of_week": "Ter",
                    "activities": [
                        "Conhecimentos EspecÃ­ficos: documentos",
                        "PortuguÃªs: RedaÃ§Ã£o oficial",
                        "QuestÃµes especÃ­ficas (10)"
                    ]
                },
                {
                    "day_of_week": "Qua",
                    "activities": [
                        "MatemÃ¡tica: RazÃµes e proporÃ§Ãµes",
                        "Conhecimentos EspecÃ­ficos: rotina de escritÃ³rio",
                        "AnÃ¡lise de dÃºvidas anteriores"
                    ]
                },
                {
                    "day_of_week": "Qui",
                    "activities": [
                        "PortuguÃªs: Ortografia + revisÃ£o",
                        "MatemÃ¡tica: SituaÃ§Ãµes-problema",
                        "RevisÃ£o geral da semana"
                    ]
                },
                {
                    "day_of_week": "Sex",
                    "activities": [
                        "Conhecimentos EspecÃ­ficos: noÃ§Ãµes de protocolo",
                        "RedaÃ§Ã£o de ofÃ­cio simples",
                        "Flashcards de temas importantes"
                    ]
                },
                {
                    "day_of_week": "SÃ¡b",
                    "activities": [
                        "Simulado 2 (40 questÃµes)",
                        "CorreÃ§Ã£o detalhada",
                        "ReforÃ§o nos erros"
                    ]
                },
                {
                    "day_of_week": "Seg (2Âª semana)",
                    "activities": [
                        "PortuguÃªs: InterpretaÃ§Ã£o aprofundada",
                        "MatemÃ¡tica: lÃ³gica bÃ¡sica",
                        "ResoluÃ§Ã£o de erros anteriores"
                    ]
                },
                {
                    "day_of_week": "Ter (2Âª semana)",
                    "activities": [
                        "Conhecimentos EspecÃ­ficos: prÃ¡ticas de escritÃ³rio",
                        "PortuguÃªs: uso do \"que\" e \"se\"",
                        "Mini simulado (PortuguÃªs)"
                    ]
                },
                {
                    "day_of_week": "Qua (2Âª semana)",
                    "activities": [
                        "MatemÃ¡tica: revisÃ£o dos tÃ³picos",
                        "Conhecimentos EspecÃ­ficos: atendimento interno e externo",
                        "Flashcards e resumos"
                    ]
                },
                {
                    "day_of_week": "Qui (2Âª semana)",
                    "activities": [
                        "PortuguÃªs: revisÃ£o geral",
                        "MatemÃ¡tica: exercÃ­cios de velocidade",
                        "AnÃ¡lise de erros comuns"
                    ]
                },
                {
                    "day_of_week": "Sex (2Âª semana)",
                    "activities": [
                        "RedaÃ§Ã£o prÃ¡tica (memorando ou ofÃ­cio)",
                        "Conhecimentos EspecÃ­ficos: revisÃ£o geral",
                        "AutoavaliaÃ§Ã£o"
                    ]
                },
                {
                    "day_of_week": "SÃ¡b (2Âª semana)",
                    "activities": [
                        "Simulado 3 (cronometrado)",
                        "CorreÃ§Ã£o + foco em portuguÃªs",
                        "Revisar onde mais errou"
                    ]
                }
            ]
        },
        {
            "title": "Semanas 5-6 (01-14/09)",
            "objective": "Intensificar prÃ¡tica, revisar erros e reforÃ§ar ritmo",
            "days": [
                {
                    "day_of_week": "Seg",
                    "activities": [
                        "PortuguÃªs: interpretaÃ§Ã£o e gramÃ¡tica",
                        "MatemÃ¡tica: revisÃ£o geral",
                        "Caderno de erros atualizado"
                    ]
                },
                {
                    "day_of_week": "Ter",
                    "activities": [
                        "Conhecimentos EspecÃ­ficos: revisÃ£o geral",
                        "Mini simulado temÃ¡tico",
                        "CorreÃ§Ã£o com grifo dos erros"
                    ]
                },
                {
                    "day_of_week": "Qua",
                    "activities": [
                        "MatemÃ¡tica: foco em problemas prÃ¡ticos",
                        "PortuguÃªs: questÃµes discursivas",
                        "Revisar estrutura de redaÃ§Ã£o"
                    ]
                },
                {
                    "day_of_week": "Qui",
                    "activities": [
                        "PortuguÃªs: crase, concordÃ¢ncia, conjunÃ§Ãµes",
                        "Conhecimentos EspecÃ­ficos",
                        "Flashcards atualizados"
                    ]
                },
                {
                    "day_of_week": "Sex",
                    "activities": [
                        "RevisÃ£o combinada de questÃµes erradas",
                        "Simulado parcial (20 questÃµes)",
                        "CorreÃ§Ã£o + marcaÃ§Ã£o de dÃºvida"
                    ]
                },
                {
                    "day_of_week": "SÃ¡b",
                    "activities": [
                        "Simulado 4 completo (cronometrado)",
                        "CorreÃ§Ã£o + estatÃ­sticas",
                        "ReflexÃ£o + planejamento da prÃ³xima semana"
                    ]
                },
                {
                    "day_of_week": "Seg (2Âª semana)",
                    "activities": [
                        "PortuguÃªs: texto e anÃ¡lise crÃ­tica",
                        "Conhecimentos EspecÃ­ficos",
                        "Revisar flashcards e anotaÃ§Ãµes"
                    ]
                },
                {
                    "day_of_week": "Ter (2Âª semana)",
                    "activities": [
                        "MatemÃ¡tica: exercÃ­cios de agilidade",
                        "Mini simulado matemÃ¡tico",
                        "CorreÃ§Ã£o e reforÃ§o"
                    ]
                },
                {
                    "day_of_week": "Qua (2Âª semana)",
                    "activities": [
                        "PortuguÃªs: gramÃ¡tica avanÃ§ada",
                        "Conhecimentos EspecÃ­ficos",
                        "Revisar questÃµes erradas da semana"
                    ]
                },
                {
                    "day_of_week": "Qui (2Âª semana)",
                    "activities": [
                        "ReforÃ§o: matÃ©ria com mais erros",
                        "RepetiÃ§Ã£o de simulado anterior",
                        "AutoavaliaÃ§Ã£o"
                    ]
                },
                {
                    "day_of_week": "Sex (2Âª semana)",
                    "activities": [
                        "RedaÃ§Ã£o simulada (tema prÃ¡tico)",
                        "CorreÃ§Ã£o e leitura de texto modelo",
                        "Ãšltimos ajustes"
                    ]
                },
                {
                    "day_of_week": "SÃ¡b (2Âª semana)",
                    "activities": [
                        "",
                        "",
                        ""
                    ]
                }
            ]
        },
        {
            "title": "Semanas 7-8 (15-27/09)",
            "objective": "Revisar tudo, fazer simulados reais e manter a mente afiada",
            "days": [
                {
                    "day_of_week": "Seg (15/09)",
                    "activities": [
                        "RevisÃ£o geral de PortuguÃªs",
                        "RevisÃ£o geral de Conhecimentos EspecÃ­ficos",
                        "QuestÃµes com gabarito comentado"
                    ]
                },
                {
                    "day_of_week": "Ter (16/09)",
                    "activities": [
                        "Simulado completo (40 questÃµes)",
                        "CorreÃ§Ã£o com marcaÃ§Ã£o dos erros",
                        "Revisar os 5 piores erros"
                    ]
                },
                {
                    "day_of_week": "Qua (17/09)",
                    "activities": [
                        "MatemÃ¡tica: problemas + revisÃ£o",
                        "RedaÃ§Ã£o administrativa curta",
                        "Revisar estrutura e linguagem"
                    ]
                },
                {
                    "day_of_week": "Qui (18/09)",
                    "activities": [
                        "RevisÃ£o temÃ¡tica: PortuguÃªs (gramÃ¡tica)",
                        "QuestÃµes especÃ­ficas do cargo",
                        "Atualizar caderno de erros"
                    ]
                },
                {
                    "day_of_week": "Sex (19/09)",
                    "activities": [
                        "Simulado parcial cronometrado",
                        "CorreÃ§Ã£o + marcaÃ§Ã£o dos acertos",
                        "RespiraÃ§Ã£o e foco (sem tela)"
                    ]
                },
                {
                    "day_of_week": "SÃ¡b (20/09)",
                    "activities": [
                        "Simulado 100% cronometrado (3h)",
                        "CorreÃ§Ã£o completa",
                        "Anotar tempo e controle emocional"
                    ]
                },
                {
                    "day_of_week": "Seg (22/09)",
                    "activities": [
                        "RevisÃ£o de todo o caderno de erros",
                        "QuestÃµes revisadas por tema",
                        "Repetir 10 questÃµes erradas"
                    ]
                },
                {
                    "day_of_week": "Ter (23/09)",
                    "activities": [
                        "RevisÃ£o final de MatemÃ¡tica",
                        "Mini simulado temÃ¡tico",
                        "CorreÃ§Ã£o e resumo mental"
                    ]
                },
                {
                    "day_of_week": "Qua (24/09)",
                    "activities": [
                        "RevisÃ£o de PortuguÃªs com foco em texto",
                        "Releitura de redaÃ§Ãµes feitas",
                        "Anotar dicas de Ãºltima hora"
                    ]
                },
                {
                    "day_of_week": "Qui (25/09)",
                    "activities": [
                        "RevisÃ£o final de Conhecimentos EspecÃ­ficos",
                        "Resumo em voz alta (autodidata)",
                        "Leitura motivacional"
                    ]
                },
                {
                    "day_of_week": "Sex (26/09)",
                    "activities": [
                        "Simulado leve (20 questÃµes mistas)",
                        "RevisÃ£o rÃ¡pida (sem aprofundar)",
                        "Organizar documentos da prova"
                    ]
                },
                {
                    "day_of_week": "SÃ¡b (27/09)",
                    "activities": [
                        "Releitura de anotaÃ§Ãµes principais",
                        "Relaxamento (sem conteÃºdo novo)",
                        "Dormir cedo, mente tranquila"
                    ]
                }
            ]
        },
        {
            "title": "Dia da Prova (28/09)",
            "objective": "",
            "days": [
                {
                    "day_of_week": "Domingo",
                    "activities": [
                        "Acorde com antecedÃªncia",
                        "CafÃ© da manhÃ£ leve e nutritivo",
                        "Leve documento com foto + caneta preta",
                        "Mantenha a calma: vocÃª se preparou ðŸ’ª"
                    ]
                }
            ]
        }
    ]
};

// Global variables
let progressData = {};
let totalActivities = 0;
let completedActivities = 0;

// Activity hours mapping
const activityHours = ['1Âª hora', '2Âª hora', 'Ãšltimos 30 min'];

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    loadProgress();
    renderStudySections();
    updateProgressDisplay();
    updateCurrentDate();
    setupEventListeners();
});

// Initialize application
function initializeApp() {
    // Calculate total activities
    studyPlan.sections.forEach((section, sectionIndex) => {
        section.days.forEach((day, dayIndex) => {
            day.activities.forEach((activity, activityIndex) => {
                if (activity.trim() !== '') {
                    totalActivities++;
                }
            });
        });
    });
    
    // Initialize progress data structure
    studyPlan.sections.forEach((section, sectionIndex) => {
        progressData[sectionIndex] = {};
        section.days.forEach((day, dayIndex) => {
            progressData[sectionIndex][dayIndex] = {};
            day.activities.forEach((activity, activityIndex) => {
                if (activity.trim() !== '') {
                    progressData[sectionIndex][dayIndex][activityIndex] = false;
                }
            });
        });
    });
}

// Load progress from localStorage
function loadProgress() {
    const savedProgress = localStorage.getItem('studyProgress');
    if (savedProgress) {
        try {
            const parsed = JSON.parse(savedProgress);
            progressData = { ...progressData, ...parsed };
        } catch (e) {
            console.error('Error loading progress:', e);
        }
    }
    calculateCompletedActivities();
}

// Save progress to localStorage
function saveProgress() {
    try {
        localStorage.setItem('studyProgress', JSON.stringify(progressData));
    } catch (e) {
        console.error('Error saving progress:', e);
    }
}

// Calculate completed activities
function calculateCompletedActivities() {
    completedActivities = 0;
    Object.values(progressData).forEach(section => {
        Object.values(section).forEach(day => {
            Object.values(day).forEach(completed => {
                if (completed) completedActivities++;
            });
        });
    });
}

// Render study sections
function renderStudySections() {
    const container = document.getElementById('studySections');
    container.innerHTML = '';
    
    studyPlan.sections.forEach((section, sectionIndex) => {
        const sectionElement = createSectionElement(section, sectionIndex);
        container.appendChild(sectionElement);
    });
}

// Create section element
function createSectionElement(section, sectionIndex) {
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'section';
    sectionDiv.innerHTML = `
        <div class="section-header" onclick="toggleSection(${sectionIndex})">
            <div>
                <div class="section-title">${section.title}</div>
                <div class="section-objective">${section.objective}</div>
            </div>
            <div class="section-toggle">
                <div class="section-progress">
                    <div class="section-progress-fill" id="sectionProgress${sectionIndex}"></div>
                </div>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
        </div>
        <div class="section-content">
            <div class="days-container" id="daysContainer${sectionIndex}">
                ${renderDays(section.days, sectionIndex)}
            </div>
        </div>
    `;
    
    return sectionDiv;
}

// Render days
function renderDays(days, sectionIndex) {
    return days.map((day, dayIndex) => {
        const dayProgress = calculateDayProgress(sectionIndex, dayIndex);
        const totalDayActivities = day.activities.filter(activity => activity.trim() !== '').length;
        
        return `
            <div class="day-item">
                <div class="day-header">
                    <div class="day-title">
                        <i class="fas fa-calendar-day"></i>
                        ${day.day_of_week}
                    </div>
                    <div class="day-progress">${dayProgress.completed}/${dayProgress.total} atividades completas</div>
                </div>
                <div class="activities-list">
                    ${renderActivities(day.activities, sectionIndex, dayIndex)}
                </div>
            </div>
        `;
    }).join('');
}

// Render activities
function renderActivities(activities, sectionIndex, dayIndex) {
    return activities.map((activity, activityIndex) => {
        if (activity.trim() === '') return '';
        
        const isCompleted = progressData[sectionIndex]?.[dayIndex]?.[activityIndex] || false;
        const activityHour = activityHours[activityIndex] || `Atividade ${activityIndex + 1}`;
        
        return `
            <div class="activity-item ${isCompleted ? 'completed' : ''}">
                <div class="custom-checkbox">
                    <input type="checkbox" 
                           id="activity_${sectionIndex}_${dayIndex}_${activityIndex}"
                           ${isCompleted ? 'checked' : ''}
                           onchange="toggleActivity(${sectionIndex}, ${dayIndex}, ${activityIndex})">
                    <span class="checkmark"></span>
                </div>
                <div class="activity-text">
                    <span class="activity-hour">${activityHour}:</span>
                    ${activity}
                </div>
            </div>
        `;
    }).join('');
}

// Calculate day progress
function calculateDayProgress(sectionIndex, dayIndex) {
    const dayData = progressData[sectionIndex]?.[dayIndex] || {};
    const completed = Object.values(dayData).filter(Boolean).length;
    const total = Object.keys(dayData).length;
    return { completed, total };
}

// Calculate section progress
function calculateSectionProgress(sectionIndex) {
    const sectionData = progressData[sectionIndex] || {};
    let completed = 0;
    let total = 0;
    
    Object.values(sectionData).forEach(dayData => {
        Object.values(dayData).forEach(activityCompleted => {
            total++;
            if (activityCompleted) completed++;
        });
    });
    
    return { completed, total };
}

// Toggle section expansion
function toggleSection(sectionIndex) {
    const section = document.querySelectorAll('.section')[sectionIndex];
    section.classList.toggle('expanded');
}

// Toggle activity completion
function toggleActivity(sectionIndex, dayIndex, activityIndex) {
    if (!progressData[sectionIndex]) progressData[sectionIndex] = {};
    if (!progressData[sectionIndex][dayIndex]) progressData[sectionIndex][dayIndex] = {};
    
    progressData[sectionIndex][dayIndex][activityIndex] = !progressData[sectionIndex][dayIndex][activityIndex];
    
    calculateCompletedActivities();
    updateProgressDisplay();
    updateSectionProgress(sectionIndex);
    updateDayProgress(sectionIndex, dayIndex);
    saveProgress();
    
    // Add animation to the activity item
    const activityElement = document.getElementById(`activity_${sectionIndex}_${dayIndex}_${activityIndex}`).closest('.activity-item');
    if (progressData[sectionIndex][dayIndex][activityIndex]) {
        activityElement.classList.add('completed');
    } else {
        activityElement.classList.remove('completed');
    }
}

// Update progress display
function updateProgressDisplay() {
    const percentage = totalActivities > 0 ? Math.round((completedActivities / totalActivities) * 100) : 0;
    
    // Update percentage text
    document.querySelector('.progress-percentage').textContent = `${percentage}%`;
    
    // Update progress ring
    const progressRing = document.querySelector('.progress-ring-fill');
    const circumference = 2 * Math.PI * 50; // radius = 50
    const offset = circumference - (percentage / 100) * circumference;
    progressRing.style.strokeDashoffset = offset;
    
    // Update counter
    document.querySelector('.completed-count').textContent = completedActivities;
    document.querySelector('.total-count').textContent = totalActivities;
}

// Update section progress
function updateSectionProgress(sectionIndex) {
    const progress = calculateSectionProgress(sectionIndex);
    const percentage = progress.total > 0 ? (progress.completed / progress.total) * 100 : 0;
    
    const progressFill = document.getElementById(`sectionProgress${sectionIndex}`);
    if (progressFill) {
        progressFill.style.width = `${percentage}%`;
    }
}

// Update day progress
function updateDayProgress(sectionIndex, dayIndex) {
    const dayProgress = calculateDayProgress(sectionIndex, dayIndex);
    const dayProgressElement = document.querySelectorAll('.day-progress')[dayIndex];
    if (dayProgressElement) {
        dayProgressElement.textContent = `${dayProgress.completed}/${dayProgress.total} atividades completas`;
    }
}

// Update all section progress bars
function updateAllSectionProgress() {
    studyPlan.sections.forEach((section, sectionIndex) => {
        updateSectionProgress(sectionIndex);
    });
}

// Update current date
function updateCurrentDate() {
    const now = new Date();
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    const dateString = now.toLocaleDateString('pt-BR', options);
    document.getElementById('currentDate').textContent = dateString;
}

// Setup event listeners
function setupEventListeners() {
    // Reset button
    document.getElementById('resetBtn').addEventListener('click', showResetModal);
    
    // Modal buttons
    document.getElementById('cancelBtn').addEventListener('click', hideResetModal);
    document.getElementById('confirmBtn').addEventListener('click', resetProgress);
    
    // Export button
    document.getElementById('exportBtn').addEventListener('click', exportProgress);
    
    // Share button
    document.querySelector('.share-btn').addEventListener('click', shareProgress);
    
    // Close modal when clicking outside
    document.getElementById('confirmModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideResetModal();
        }
    });
    
    // Update all section progress on load
    setTimeout(updateAllSectionProgress, 100);
}

// Show reset modal
function showResetModal() {
    document.getElementById('confirmModal').style.display = 'block';
}

// Hide reset modal
function hideResetModal() {
    document.getElementById('confirmModal').style.display = 'none';
}

// Reset progress
function resetProgress() {
    // Reset progress data
    studyPlan.sections.forEach((section, sectionIndex) => {
        section.days.forEach((day, dayIndex) => {
            day.activities.forEach((activity, activityIndex) => {
                if (activity.trim() !== '') {
                    progressData[sectionIndex][dayIndex][activityIndex] = false;
                }
            });
        });
    });
    
    // Update displays
    calculateCompletedActivities();
    updateProgressDisplay();
    updateAllSectionProgress();
    
    // Re-render sections to update checkboxes
    renderStudySections();
    
    // Save and hide modal
    saveProgress();
    hideResetModal();
    
    // Show success message
    showNotification('Progresso reiniciado com sucesso!');
}

// Export progress
function exportProgress() {
    const exportData = {
        timestamp: new Date().toISOString(),
        totalActivities: totalActivities,
        completedActivities: completedActivities,
        percentage: Math.round((completedActivities / totalActivities) * 100),
        progress: progressData,
        sections: studyPlan.sections.map((section, sectionIndex) => {
            const sectionProgress = calculateSectionProgress(sectionIndex);
            return {
                title: section.title,
                objective: section.objective,
                completed: sectionProgress.completed,
                total: sectionProgress.total,
                percentage: Math.round((sectionProgress.completed / sectionProgress.total) * 100)
            };
        })
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `progresso-estudos-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showNotification('Progresso exportado com sucesso!');
}

// Share progress
function shareProgress() {
    const percentage = Math.round((completedActivities / totalActivities) * 100);
    const shareText = `ðŸŽ¯ Meu progresso no Plano de Estudos para Auxiliar de EscritÃ³rio: ${percentage}% completo (${completedActivities}/${totalActivities} atividades)! ðŸ“šðŸ’ª`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Progresso do Plano de Estudos',
            text: shareText,
            url: window.location.href
        }).catch(console.error);
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(shareText).then(() => {
            showNotification('Texto copiado para a Ã¡rea de transferÃªncia!');
        }).catch(() => {
            showNotification('Erro ao copiar texto');
        });
    }
}

// Show notification
function showNotification(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #bb86fc 0%, #6200ea 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(187, 134, 252, 0.3);
        z-index: 1001;
        font-weight: 600;
        animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    
    // Add animation keyframes
    if (!document.querySelector('#notificationStyles')) {
        const style = document.createElement('style');
        style.id = 'notificationStyles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Auto-save progress every 30 seconds
setInterval(saveProgress, 30000);

// Handle page visibility change to save progress
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        saveProgress();
    }
});

// Save progress before page unload
window.addEventListener('beforeunload', saveProgress);

