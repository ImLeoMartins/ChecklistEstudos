// Study Plan Data
const studyPlan = {
    "title": "Plano de Estudos - Auxiliar de Escritório",
    "sections": [
        {
            "title": "Semanas 1-2 (05-17/08)",
            "objective": "Revisar o básico e identificar onde você erra mais",
            "days": [
                {
                    "day_of_week": "Seg",
                    "activities": [
                        "Português: Interpretação de texto",
                        "Matemática: Quatro operações",
                        "Anotar erros e dúvidas"
                    ]
                },
                {
                    "day_of_week": "Ter",
                    "activities": [
                        "Conhecimentos Específicos: funções do cargo",
                        "Português: Ortografia",
                        "Questões rápidas (5 a 10)"
                    ]
                },
                {
                    "day_of_week": "Qua",
                    "activities": [
                        "Matemática: Frações e porcentagem",
                        "Conhecimentos Específicos: atendimento",
                        "Resumo do dia"
                    ]
                },
                {
                    "day_of_week": "Qui",
                    "activities": [
                        "Português: Pontuação e crase",
                        "Matemática: Proporção",
                        "Flashcards de revisão"
                    ]
                },
                {
                    "day_of_week": "Sex",
                    "activities": [
                        "Conhecimentos Específicos: organização, arquivos",
                        "Português: Acentuação e tipos de palavras",
                        "Mini simulado (10 questões)"
                    ]
                },
                {
                    "day_of_week": "Sáb",
                    "activities": [
                        "Simulado parcial (20 questões)",
                        "Correção + análise de erros",
                        "Reforço nos erros"
                    ]
                },
                {
                    "day_of_week": "Seg (2ª semana)",
                    "activities": [
                        "Português: Pronomes e verbos",
                        "Matemática: Regra de três",
                        "Caderno de erros"
                    ]
                },
                {
                    "day_of_week": "Ter (2ª semana)",
                    "activities": [
                        "Conhecimentos Específicos: atendimento ao público",
                        "Português: Concordância verbal e nominal",
                        "Questões práticas"
                    ]
                },
                {
                    "day_of_week": "Qua (2ª semana)",
                    "activities": [
                        "Matemática: Situações-problema",
                        "Conhecimentos Específicos: arquivos e protocolo",
                        "Anotar dúvidas e revisar"
                    ]
                },
                {
                    "day_of_week": "Qui (2ª semana)",
                    "activities": [
                        "Português: Classes gramaticais",
                        "Matemática: Revisão geral",
                        "Revisar flashcards"
                    ]
                },
                {
                    "day_of_week": "Sex (2ª semana)",
                    "activities": [
                        "Conhecimentos Específicos: textos administrativos",
                        "Redação administrativa curta",
                        "Revisar português"
                    ]
                },
                {
                    "day_of_week": "Sáb (2ª semana)",
                    "activities": [
                        "Simulado 1 (40 questões cronometrado)",
                        "Correção e marcação dos erros",
                        "Revisar só os erros"
                    ]
                }
            ]
        },
        {
            "title": "Semanas 3-4 (18-31/08)",
            "objective": "Aprofundar e aumentar volume de questões",
            "days": [
                {
                    "day_of_week": "Seg",
                    "activities": [
                        "Português: Conjunções e conectivos",
                        "Matemática: Porcentagem",
                        "Releitura de resumos"
                    ]
                },
                {
                    "day_of_week": "Ter",
                    "activities": [
                        "Conhecimentos Específicos: documentos",
                        "Português: Redação oficial",
                        "Questões específicas (10)"
                    ]
                },
                {
                    "day_of_week": "Qua",
                    "activities": [
                        "Matemática: Razões e proporções",
                        "Conhecimentos Específicos: rotina de escritório",
                        "Análise de dúvidas anteriores"
                    ]
                },
                {
                    "day_of_week": "Qui",
                    "activities": [
                        "Português: Ortografia + revisão",
                        "Matemática: Situações-problema",
                        "Revisão geral da semana"
                    ]
                },
                {
                    "day_of_week": "Sex",
                    "activities": [
                        "Conhecimentos Específicos: noções de protocolo",
                        "Redação de ofício simples",
                        "Flashcards de temas importantes"
                    ]
                },
                {
                    "day_of_week": "Sáb",
                    "activities": [
                        "Simulado 2 (40 questões)",
                        "Correção detalhada",
                        "Reforço nos erros"
                    ]
                },
                {
                    "day_of_week": "Seg (2ª semana)",
                    "activities": [
                        "Português: Interpretação aprofundada",
                        "Matemática: lógica básica",
                        "Resolução de erros anteriores"
                    ]
                },
                {
                    "day_of_week": "Ter (2ª semana)",
                    "activities": [
                        "Conhecimentos Específicos: práticas de escritório",
                        "Português: uso do \"que\" e \"se\"",
                        "Mini simulado (Português)"
                    ]
                },
                {
                    "day_of_week": "Qua (2ª semana)",
                    "activities": [
                        "Matemática: revisão dos tópicos",
                        "Conhecimentos Específicos: atendimento interno e externo",
                        "Flashcards e resumos"
                    ]
                },
                {
                    "day_of_week": "Qui (2ª semana)",
                    "activities": [
                        "Português: revisão geral",
                        "Matemática: exercícios de velocidade",
                        "Análise de erros comuns"
                    ]
                },
                {
                    "day_of_week": "Sex (2ª semana)",
                    "activities": [
                        "Redação prática (memorando ou ofício)",
                        "Conhecimentos Específicos: revisão geral",
                        "Autoavaliação"
                    ]
                },
                {
                    "day_of_week": "Sáb (2ª semana)",
                    "activities": [
                        "Simulado 3 (cronometrado)",
                        "Correção + foco em português",
                        "Revisar onde mais errou"
                    ]
                }
            ]
        },
        {
            "title": "Semanas 5-6 (01-14/09)",
            "objective": "Intensificar prática, revisar erros e reforçar ritmo",
            "days": [
                {
                    "day_of_week": "Seg",
                    "activities": [
                        "Português: interpretação e gramática",
                        "Matemática: revisão geral",
                        "Caderno de erros atualizado"
                    ]
                },
                {
                    "day_of_week": "Ter",
                    "activities": [
                        "Conhecimentos Específicos: revisão geral",
                        "Mini simulado temático",
                        "Correção com grifo dos erros"
                    ]
                },
                {
                    "day_of_week": "Qua",
                    "activities": [
                        "Matemática: foco em problemas práticos",
                        "Português: questões discursivas",
                        "Revisar estrutura de redação"
                    ]
                },
                {
                    "day_of_week": "Qui",
                    "activities": [
                        "Português: crase, concordância, conjunções",
                        "Conhecimentos Específicos",
                        "Flashcards atualizados"
                    ]
                },
                {
                    "day_of_week": "Sex",
                    "activities": [
                        "Revisão combinada de questões erradas",
                        "Simulado parcial (20 questões)",
                        "Correção + marcação de dúvida"
                    ]
                },
                {
                    "day_of_week": "Sáb",
                    "activities": [
                        "Simulado 4 completo (cronometrado)",
                        "Correção + estatísticas",
                        "Reflexão + planejamento da próxima semana"
                    ]
                },
                {
                    "day_of_week": "Seg (2ª semana)",
                    "activities": [
                        "Português: texto e análise crítica",
                        "Conhecimentos Específicos",
                        "Revisar flashcards e anotações"
                    ]
                },
                {
                    "day_of_week": "Ter (2ª semana)",
                    "activities": [
                        "Matemática: exercícios de agilidade",
                        "Mini simulado matemático",
                        "Correção e reforço"
                    ]
                },
                {
                    "day_of_week": "Qua (2ª semana)",
                    "activities": [
                        "Português: gramática avançada",
                        "Conhecimentos Específicos",
                        "Revisar questões erradas da semana"
                    ]
                },
                {
                    "day_of_week": "Qui (2ª semana)",
                    "activities": [
                        "Reforço: matéria com mais erros",
                        "Repetição de simulado anterior",
                        "Autoavaliação"
                    ]
                },
                {
                    "day_of_week": "Sex (2ª semana)",
                    "activities": [
                        "Redação simulada (tema prático)",
                        "Correção e leitura de texto modelo",
                        "Últimos ajustes"
                    ]
                },
                {
                    "day_of_week": "Sáb (2ª semana)",
                    "activities": [
                        "",
                        "",
                        ""
                    ]
                }
            ]
        },
        {
            "title": "Semanas 7-8 (15-27/09)",
            "objective": "Revisar tudo, fazer simulados reais e manter a mente afiada",
            "days": [
                {
                    "day_of_week": "Seg (15/09)",
                    "activities": [
                        "Revisão geral de Português",
                        "Revisão geral de Conhecimentos Específicos",
                        "Questões com gabarito comentado"
                    ]
                },
                {
                    "day_of_week": "Ter (16/09)",
                    "activities": [
                        "Simulado completo (40 questões)",
                        "Correção com marcação dos erros",
                        "Revisar os 5 piores erros"
                    ]
                },
                {
                    "day_of_week": "Qua (17/09)",
                    "activities": [
                        "Matemática: problemas + revisão",
                        "Redação administrativa curta",
                        "Revisar estrutura e linguagem"
                    ]
                },
                {
                    "day_of_week": "Qui (18/09)",
                    "activities": [
                        "Revisão temática: Português (gramática)",
                        "Questões específicas do cargo",
                        "Atualizar caderno de erros"
                    ]
                },
                {
                    "day_of_week": "Sex (19/09)",
                    "activities": [
                        "Simulado parcial cronometrado",
                        "Correção + marcação dos acertos",
                        "Respiração e foco (sem tela)"
                    ]
                },
                {
                    "day_of_week": "Sáb (20/09)",
                    "activities": [
                        "Simulado 100% cronometrado (3h)",
                        "Correção completa",
                        "Anotar tempo e controle emocional"
                    ]
                },
                {
                    "day_of_week": "Seg (22/09)",
                    "activities": [
                        "Revisão de todo o caderno de erros",
                        "Questões revisadas por tema",
                        "Repetir 10 questões erradas"
                    ]
                },
                {
                    "day_of_week": "Ter (23/09)",
                    "activities": [
                        "Revisão final de Matemática",
                        "Mini simulado temático",
                        "Correção e resumo mental"
                    ]
                },
                {
                    "day_of_week": "Qua (24/09)",
                    "activities": [
                        "Revisão de Português com foco em texto",
                        "Releitura de redações feitas",
                        "Anotar dicas de última hora"
                    ]
                },
                {
                    "day_of_week": "Qui (25/09)",
                    "activities": [
                        "Revisão final de Conhecimentos Específicos",
                        "Resumo em voz alta (autodidata)",
                        "Leitura motivacional"
                    ]
                },
                {
                    "day_of_week": "Sex (26/09)",
                    "activities": [
                        "Simulado leve (20 questões mistas)",
                        "Revisão rápida (sem aprofundar)",
                        "Organizar documentos da prova"
                    ]
                },
                {
                    "day_of_week": "Sáb (27/09)",
                    "activities": [
                        "Releitura de anotações principais",
                        "Relaxamento (sem conteúdo novo)",
                        "Dormir cedo, mente tranquila"
                    ]
                }
            ]
        },
        {
            "title": "Dia da Prova (28/09)",
            "objective": "",
            "days": [
                {
                    "day_of_week": "Domingo",
                    "activities": [
                        "Acorde com antecedência",
                        "Café da manhã leve e nutritivo",
                        "Leve documento com foto + caneta preta",
                        "Mantenha a calma: você se preparou 💪"
                    ]
                }
            ]
        }
    ]
};

// Global variables
let progressData = {};
let totalActivities = 0;
let completedActivities = 0;

// Activity hours mapping
const activityHours = ['1ª hora', '2ª hora', 'Últimos 30 min'];

// Initialize the application
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
    loadProgress();
    renderStudySections();
    updateProgressDisplay();
    updateCurrentDate();
    setupEventListeners();
});

// Initialize application
function initializeApp() {
    // Calculate total activities
    studyPlan.sections.forEach((section, sectionIndex) => {
        section.days.forEach((day, dayIndex) => {
            day.activities.forEach((activity, activityIndex) => {
                if (activity.trim() !== '') {
                    totalActivities++;
                }
            });
        });
    });
    
    // Initialize progress data structure
    studyPlan.sections.forEach((section, sectionIndex) => {
        progressData[sectionIndex] = {};
        section.days.forEach((day, dayIndex) => {
            progressData[sectionIndex][dayIndex] = {};
            day.activities.forEach((activity, activityIndex) => {
                if (activity.trim() !== '') {
                    progressData[sectionIndex][dayIndex][activityIndex] = false;
                }
            });
        });
    });
}

// Load progress from localStorage
function loadProgress() {
    const savedProgress = localStorage.getItem('studyProgress');
    if (savedProgress) {
        try {
            const parsed = JSON.parse(savedProgress);
            progressData = { ...progressData, ...parsed };
        } catch (e) {
            console.error('Error loading progress:', e);
        }
    }
    calculateCompletedActivities();
}

// Save progress to localStorage
function saveProgress() {
    try {
        localStorage.setItem('studyProgress', JSON.stringify(progressData));
    } catch (e) {
        console.error('Error saving progress:', e);
    }
}

// Calculate completed activities
function calculateCompletedActivities() {
    completedActivities = 0;
    Object.values(progressData).forEach(section => {
        Object.values(section).forEach(day => {
            Object.values(day).forEach(completed => {
                if (completed) completedActivities++;
            });
        });
    });
}

// Render study sections
function renderStudySections() {
    const container = document.getElementById('studySections');
    container.innerHTML = '';
    
    studyPlan.sections.forEach((section, sectionIndex) => {
        const sectionElement = createSectionElement(section, sectionIndex);
        container.appendChild(sectionElement);
    });
}

// Create section element
function createSectionElement(section, sectionIndex) {
    const sectionDiv = document.createElement('div');
    sectionDiv.className = 'section';
    sectionDiv.innerHTML = `
        <div class="section-header" onclick="toggleSection(${sectionIndex})">
            <div>
                <div class="section-title">${section.title}</div>
                <div class="section-objective">${section.objective}</div>
            </div>
            <div class="section-toggle">
                <div class="section-progress">
                    <div class="section-progress-fill" id="sectionProgress${sectionIndex}"></div>
                </div>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </div>
        </div>
        <div class="section-content">
            <div class="days-container" id="daysContainer${sectionIndex}">
                ${renderDays(section.days, sectionIndex)}
            </div>
        </div>
    `;
    
    return sectionDiv;
}

// Render days
function renderDays(days, sectionIndex) {
    return days.map((day, dayIndex) => {
        const dayProgress = calculateDayProgress(sectionIndex, dayIndex);
        const totalDayActivities = day.activities.filter(activity => activity.trim() !== '').length;
        
        return `
            <div class="day-item">
                <div class="day-header">
                    <div class="day-title">
                        <i class="fas fa-calendar-day"></i>
                        ${day.day_of_week}
                    </div>
                    <div class="day-progress">${dayProgress.completed}/${dayProgress.total} atividades completas</div>
                </div>
                <div class="activities-list">
                    ${renderActivities(day.activities, sectionIndex, dayIndex)}
                </div>
            </div>
        `;
    }).join('');
}

// Render activities
function renderActivities(activities, sectionIndex, dayIndex) {
    return activities.map((activity, activityIndex) => {
        if (activity.trim() === '') return '';
        
        const isCompleted = progressData[sectionIndex]?.[dayIndex]?.[activityIndex] || false;
        const activityHour = activityHours[activityIndex] || `Atividade ${activityIndex + 1}`;
        
        return `
            <div class="activity-item ${isCompleted ? 'completed' : ''}">
                <div class="custom-checkbox">
                    <input type="checkbox" 
                           id="activity_${sectionIndex}_${dayIndex}_${activityIndex}"
                           ${isCompleted ? 'checked' : ''}
                           onchange="toggleActivity(${sectionIndex}, ${dayIndex}, ${activityIndex})">
                    <span class="checkmark"></span>
                </div>
                <div class="activity-text">
                    <span class="activity-hour">${activityHour}:</span>
                    ${activity}
                </div>
            </div>
        `;
    }).join('');
}

// Calculate day progress
function calculateDayProgress(sectionIndex, dayIndex) {
    const dayData = progressData[sectionIndex]?.[dayIndex] || {};
    const completed = Object.values(dayData).filter(Boolean).length;
    const total = Object.keys(dayData).length;
    return { completed, total };
}

// Calculate section progress
function calculateSectionProgress(sectionIndex) {
    const sectionData = progressData[sectionIndex] || {};
    let completed = 0;
    let total = 0;
    
    Object.values(sectionData).forEach(dayData => {
        Object.values(dayData).forEach(activityCompleted => {
            total++;
            if (activityCompleted) completed++;
        });
    });
    
    return { completed, total };
}

// Toggle section expansion
function toggleSection(sectionIndex) {
    const section = document.querySelectorAll('.section')[sectionIndex];
    section.classList.toggle('expanded');
}

// Toggle activity completion
function toggleActivity(sectionIndex, dayIndex, activityIndex) {
    if (!progressData[sectionIndex]) progressData[sectionIndex] = {};
    if (!progressData[sectionIndex][dayIndex]) progressData[sectionIndex][dayIndex] = {};
    
    progressData[sectionIndex][dayIndex][activityIndex] = !progressData[sectionIndex][dayIndex][activityIndex];
    
    calculateCompletedActivities();
    updateProgressDisplay();
    updateSectionProgress(sectionIndex);
    updateDayProgress(sectionIndex, dayIndex);
    saveProgress();
    
    // Add animation to the activity item
    const activityElement = document.getElementById(`activity_${sectionIndex}_${dayIndex}_${activityIndex}`).closest('.activity-item');
    if (progressData[sectionIndex][dayIndex][activityIndex]) {
        activityElement.classList.add('completed');
    } else {
        activityElement.classList.remove('completed');
    }
}

// Update progress display
function updateProgressDisplay() {
    const percentage = totalActivities > 0 ? Math.round((completedActivities / totalActivities) * 100) : 0;
    
    // Update percentage text
    document.querySelector('.progress-percentage').textContent = `${percentage}%`;
    
    // Update progress ring
    const progressRing = document.querySelector('.progress-ring-fill');
    const circumference = 2 * Math.PI * 50; // radius = 50
    const offset = circumference - (percentage / 100) * circumference;
    progressRing.style.strokeDashoffset = offset;
    
    // Update counter
    document.querySelector('.completed-count').textContent = completedActivities;
    document.querySelector('.total-count').textContent = totalActivities;
}

// Update section progress
function updateSectionProgress(sectionIndex) {
    const progress = calculateSectionProgress(sectionIndex);
    const percentage = progress.total > 0 ? (progress.completed / progress.total) * 100 : 0;
    
    const progressFill = document.getElementById(`sectionProgress${sectionIndex}`);
    if (progressFill) {
        progressFill.style.width = `${percentage}%`;
    }
}

// Update day progress
function updateDayProgress(sectionIndex, dayIndex) {
    const dayProgress = calculateDayProgress(sectionIndex, dayIndex);
    const dayProgressElement = document.querySelectorAll('.day-progress')[dayIndex];
    if (dayProgressElement) {
        dayProgressElement.textContent = `${dayProgress.completed}/${dayProgress.total} atividades completas`;
    }
}

// Update all section progress bars
function updateAllSectionProgress() {
    studyPlan.sections.forEach((section, sectionIndex) => {
        updateSectionProgress(sectionIndex);
    });
}

// Update current date
function updateCurrentDate() {
    const now = new Date();
    const options = { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    };
    const dateString = now.toLocaleDateString('pt-BR', options);
    document.getElementById('currentDate').textContent = dateString;
}

// Setup event listeners
function setupEventListeners() {
    // Reset button
    document.getElementById('resetBtn').addEventListener('click', showResetModal);
    
    // Modal buttons
    document.getElementById('cancelBtn').addEventListener('click', hideResetModal);
    document.getElementById('confirmBtn').addEventListener('click', resetProgress);
    
    // Export button
    document.getElementById('exportBtn').addEventListener('click', exportProgress);
    
    // Share button
    document.querySelector('.share-btn').addEventListener('click', shareProgress);
    
    // Close modal when clicking outside
    document.getElementById('confirmModal').addEventListener('click', function(e) {
        if (e.target === this) {
            hideResetModal();
        }
    });
    
    // Update all section progress on load
    setTimeout(updateAllSectionProgress, 100);
}

// Show reset modal
function showResetModal() {
    document.getElementById('confirmModal').style.display = 'block';
}

// Hide reset modal
function hideResetModal() {
    document.getElementById('confirmModal').style.display = 'none';
}

// Reset progress
function resetProgress() {
    // Reset progress data
    studyPlan.sections.forEach((section, sectionIndex) => {
        section.days.forEach((day, dayIndex) => {
            day.activities.forEach((activity, activityIndex) => {
                if (activity.trim() !== '') {
                    progressData[sectionIndex][dayIndex][activityIndex] = false;
                }
            });
        });
    });
    
    // Update displays
    calculateCompletedActivities();
    updateProgressDisplay();
    updateAllSectionProgress();
    
    // Re-render sections to update checkboxes
    renderStudySections();
    
    // Save and hide modal
    saveProgress();
    hideResetModal();
    
    // Show success message
    showNotification('Progresso reiniciado com sucesso!');
}

// Export progress
function exportProgress() {
    const exportData = {
        timestamp: new Date().toISOString(),
        totalActivities: totalActivities,
        completedActivities: completedActivities,
        percentage: Math.round((completedActivities / totalActivities) * 100),
        progress: progressData,
        sections: studyPlan.sections.map((section, sectionIndex) => {
            const sectionProgress = calculateSectionProgress(sectionIndex);
            return {
                title: section.title,
                objective: section.objective,
                completed: sectionProgress.completed,
                total: sectionProgress.total,
                percentage: Math.round((sectionProgress.completed / sectionProgress.total) * 100)
            };
        })
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `progresso-estudos-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showNotification('Progresso exportado com sucesso!');
}

// Share progress
function shareProgress() {
    const percentage = Math.round((completedActivities / totalActivities) * 100);
    const shareText = `🎯 Meu progresso no Plano de Estudos para Auxiliar de Escritório: ${percentage}% completo (${completedActivities}/${totalActivities} atividades)! 📚💪`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Progresso do Plano de Estudos',
            text: shareText,
            url: window.location.href
        }).catch(console.error);
    } else {
        // Fallback: copy to clipboard
        navigator.clipboard.writeText(shareText).then(() => {
            showNotification('Texto copiado para a área de transferência!');
        }).catch(() => {
            showNotification('Erro ao copiar texto');
        });
    }
}

// Show notification
function showNotification(message) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #bb86fc 0%, #6200ea 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(187, 134, 252, 0.3);
        z-index: 1001;
        font-weight: 600;
        animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    
    // Add animation keyframes
    if (!document.querySelector('#notificationStyles')) {
        const style = document.createElement('style');
        style.id = 'notificationStyles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Auto-save progress every 30 seconds
setInterval(saveProgress, 30000);

// Handle page visibility change to save progress
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        saveProgress();
    }
});

// Save progress before page unload
window.addEventListener('beforeunload', saveProgress);

